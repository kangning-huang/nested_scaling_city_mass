# Nested Scaling of City Mass — Project Repo

Status
- This project accompanies our manuscript on nested scaling relationships of population and built environment mass across cities and neighborhoods.
- The paper is currently under review / in revision at Nature Cities.
- Live site: https://kangning-huang.github.io/nested_scaling_city_mass/

Key Analyses (implemented in scripts and used to power the site)
- City-level scaling: log–log scaling between total built mass and population across cities using decentered regression (store slope, mean log-pop, mean log-mass, and counts).
- Neighborhood-level scaling: per-city regressions over H3 resolution 7 (neighborhood scale) hexagons; also global and per-country neighborhood regressions.
- Robustness checks: multiple data sources for built mass (Esch 2022, Li 2022, Liu 2024), spatial nudging, and filtering sensitivity (summarized in results; not all exposed in the UI).

Interactive Website
- Map + two panels:
  - Global → Country → City navigation with a light basemap.
  - City view renders H3 R7 hexes colored by a log scale of either Population (people) or Built Mass (tons); hover tooltips show values.
  - City panel: city-level scatter of log(pop) vs log(built mass) with OLS regression and 95% CI (global or per-country scope).
  - Neighborhood panel: neighborhood-level scatter (global subsample, country-only subsample, or just the active city), with OLS regression and 95% CI; includes a density overlay option.

How the Website Is Constructed
- Frontend: Vite + React + MapLibre GL + deck.gl (H3HexagonLayer) with a MapTiler light basemap.
- Data: Static JSON artifacts in `web/public/webdata/`, generated by scripts in `scripts/web_prep/` from the R7 neighborhoods CSV and city/country summaries.
- Regressions: OLS slopes with 95% CIs and decentered anchors (`x0`, `y0`) computed by `scripts/web_prep/compute_regressions.py`.
- Performance: Per-country city aggregates; per-city hex feeds; stratified subsamples for global/country neighborhood scatters.

Local Development
1) `cd web && npm ci`
2) Set env var `VITE_MAPTILER_KEY` (free MapTiler key)
3) (Optional) If you need local data, run `bash ../scripts/unzip_webdata.sh` **only in CI or a throwaway workspace**; avoid unzipping locally to keep Drive fast.
4) `npm run dev`

Deployment (GitHub Pages)
- Workflow in `.github/workflows/deploy.yml` builds from `web/` and publishes to `gh-pages`, expanding `web/public/webdata/*.zip` via `scripts/unzip_webdata.sh`.
- A lightweight workflow `.github/workflows/unzip-webdata.yml` runs on every push to ensure archives can be expanded in CI (no local unzipping needed).
- Set repo secret `MAPTILER_KEY` with your MapTiler key.
- Push to `main` (or `master`) to deploy. Pages URL: `https://<user>.github.io/<repo>/` (live at https://kangning-huang.github.io/nested_scaling_city_mass/).

Version-Controlled Folders
- `web/`: the web app (source + public webdata artifacts)
- `scripts/`: web data-prep pipeline
- `results/`: selected results referenced in documentation
- `.github/`: CI for Pages deployment

**Data Dictionary**
- `webdata/countries.geojson`:
  - FeatureCollection; feature properties: `iso3` (ISO-3), `name` (country).
- `webdata/cities_agg/*.json` (global and `country=ISO.json`): list of cities.
  - Fields: `country_iso` (ISO-3), `city_id` (int), `city` (name), `pop_total` (people), `mass_total` (tons), `n_hex` (count of H3 R7 cells), `sample_h3` (representative H3 index), `log_pop` (log10), `log_mass` (log10).
- `webdata/index/country_to_cities.json`:
  - Object map: `ISO-3` → `[city_id, ...]`.
- `webdata/index/city_meta.json`:
  - Object map: `city_id` → `{ city, country_iso, sample_h3, n_hex }`.
- `webdata/scatter_samples/global_neighborhood.json` and `country=ISO.json`:
  - List of subsampled neighborhoods; fields: `country_iso`, `city_id`, `log_pop` (log10 people), `log_mass` (log10 tons).
- `webdata/regression/*` (OLS summaries; decentered form):
  - Common fields: `slope`, `slope_lo`, `slope_hi` (95% CI), `x0`, `y0` (means of log10 pop/mass), `n` (observations), `r2`.
  - Files: `global_city.json`; `country/ISO.json` (adds `country_iso`); `global_neighborhood.json`; `country_neighborhood/ISO.json` (adds `country_iso`); `city_neighborhood/{city_id}.json` (adds `city_id`).
  - Plotting uses `y = y0 + slope * (x - x0)`; CI band from `slope_lo..slope_hi`.
- `webdata/hex/city=ID.json` (per-city H3 feed for map):
  - List of hexes; fields: `h3index` (res 7), `population_2015` (people), `total_built_mass_tons` (tons), `city_id`, `country_iso`.

Notes
- All logs are base-10; population in persons; built mass in metric tons.
- Color ramp on the map is log-scaled per selected city and metric; legends show log ticks and formatted min/max values.
